<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corgres - SLABs Pricing</title>
  <link rel="icon" type="image/png" href="/images/mylogo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <link rel="stylesheet" href="/css/app.css">
  <meta name="description" content="Corgres SLABs Retail Pricing Calculator">
  <meta property="og:title" content="Corgres – SLABs Pricing">
  <meta property="og:description" content="Instant retail pricing for slabs with live presence.">
  <meta property="og:image" content="/images/mylogo.png">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <style>
    :root { --dark-color: #0f172a; --primary-color: #e11d48; --neutral-100:#f8f9fa; --neutral-300:#ced4da; }
    body { background-color: #fffbfa; }
    .section { background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-calc { background: linear-gradient(135deg, #ef476f, #e11d48); color: #fff; border: none; border-radius: 999px; padding: 0.8rem 1.25rem; font-weight: 700; }
    /* Calc button state variants (red when invalid, green when valid) */
    .btn-calc.is-valid { background: linear-gradient(135deg, #198754, #157347) !important; box-shadow: 0 10px 20px rgba(25, 135, 84, 0.25) !important; }
    .btn-calc.is-invalid { background: linear-gradient(135deg, #ef476f, #e11d48) !important; }
    .retail-badge { background: linear-gradient(135deg, #198754, #157347); color: #fff; }
    /* Match pricing page rounded pills for outline buttons */
    .btn-outline-primary, .btn-outline-secondary, .btn.btn-sm.btn-outline-secondary { border-radius: 999px; }
    /* Fix pill groups: only outer ends rounded, middle joints straight, collapse borders */
    .btn-group.pill-group > .btn,
    .btn-group.pill-group > label.btn {
      border-radius: 0 !important;
      position: relative;
      margin-left: -1px; /* collapse adjacent borders */
    }
    .btn-group.pill-group > .btn:first-of-type,
    .btn-group.pill-group > label.btn:first-of-type {
      border-top-left-radius: 999px !important;
      border-bottom-left-radius: 999px !important;
      margin-left: 0;
    }
    .btn-group.pill-group > .btn:last-of-type,
    .btn-group.pill-group > label.btn:last-of-type {
      border-top-right-radius: 999px !important;
      border-bottom-right-radius: 999px !important;
    }
    /* Checked/active state should sit above neighbors to hide seams */
    .btn-group.pill-group > .btn:focus,
    .btn-group.pill-group > .btn:active,
    .btn-group.pill-group > .btn:hover,
    .btn-group.pill-group > input.btn-check:checked + label.btn {
      z-index: 2;
    }
    /* Rounded input group look (match pricing) */
    .input-group .btn, .input-group .input-group-text { border-radius: 999px; }
    .input-group > .btn:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
    .input-group > .form-control { border-radius: 0; }
    .input-group > .btn:last-child { border-top-left-radius: 0; border-bottom-left-radius: 0; }
    .unit-grey { background-color: var(--neutral-100)!important; border-color: var(--neutral-300)!important; }
    .form-select { border-radius: 999px; }

    /* Stronger visibility for selected quantity mode */
    #qty_box .btn[data-mode].active {
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
      color: #fff !important;
      font-weight: 700;
      box-shadow: 0 0 0 0.15rem rgba(225, 29, 72, 0.25);
    }

    /* Validation colors like pricing */
    .input-group.validation-invalid .btn,
    .input-group.validation-invalid .input-group-text,
    .input-group.validation-invalid .form-control { background-color:#dc3545!important; border-color:#dc3545!important; color:#fff!important; }
    .input-group.validation-valid .btn,
    .input-group.validation-valid .input-group-text,
    .input-group.validation-valid .form-control { background-color:#198754!important; border-color:#198754!important; color:#fff!important; }
    /* Compact, space-efficient chip groups */
    .pill-group.scrollable {
      display: inline-flex;
      gap: 4px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      max-width: 100%;
    }
    .pill-group.scrollable > .btn,
    .pill-group.scrollable > label.btn {
      flex: 0 0 auto; /* prevent stretching so we can scroll horizontally */
    }
    /* Thickness/Dimensions inline layout on md+ screens */
    .thdim-row { display: block; }
    .thdim-row .inline-block { display: block; }
    @media (min-width: 768px) {
      .thdim-row { display: block; }
      .thdim-row .inline-block { display: block; margin-bottom: 0.5rem !important; }
      .thdim-row .th-label, .thdim-row .dim-label { margin-bottom: 0.25rem !important; white-space: nowrap; }
      /* Stack groups vertically on all screen sizes */
      #thickness_group.scrollable, #dimensions_group.scrollable { max-width: 100%; }
    }
  #result { clear: both; position: relative; z-index: 1; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light mb-4 py-3">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="/">
        <img src="/images/mylogo.png" alt="Corgres" height="36">
        <span class="fw-bold ms-2" style="color: var(--dark-color);">Corgres Σταγάκης</span>
        <span class="text-muted d-none d-md-inline mx-2">|</span>
        <span class="text-muted d-none d-md-inline">SLABs Pricing</span>
      </a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="themeToggle" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle theme">
          <i class="fa-solid fa-moon"></i>
        </button>
        <div id="presenceChip" class="presence-chip">
          <span class="badge bg-success" id="presenceCount">0 online</span>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#presencePanel" aria-expanded="false" title="Show online">
            <i class="fa-solid fa-users"></i>
          </button>
        </div>
        <a class="btn btn-outline-secondary d-none d-lg-inline" href="/"><i class="fas fa-home fa-fw me-2"></i>Home</a>
        <a class="btn btn-outline-secondary d-none d-lg-inline" href="/logs"><i class="fas fa-list-alt fa-fw me-2"></i>Logs</a>
      </div>
    </div>
  </nav>
  <div class="collapse position-absolute end-0 mt-2" id="presencePanel" style="min-width: 320px; z-index: 1050;">
    <div class="card shadow-sm">
      <div class="card-body p-2"><div id="presenceList" class="small"></div></div>
    </div>
  </div>

  <div class="container">
    <div class="section">
      <h3 class="mb-3"><i class="fas fa-tablet-alt me-2"></i> Υπολογισμός Λιανικής Τιμής (SLABs)</h3>
      <form id="slabForm" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Εταιρία</label>
          <div class="btn-group w-100 pill-group" role="group" aria-label="Εταιρία" id="brand_group">
            <input type="radio" class="btn-check" name="brandopt" id="brand_inf" autocomplete="off" data-value="infinity" checked>
            <label class="btn btn-sm btn-outline-secondary" for="brand_inf">Infinity</label>
            <input type="radio" class="btn-check" name="brandopt" id="brand_mir" autocomplete="off" data-value="mirage">
            <label class="btn btn-sm btn-outline-secondary" for="brand_mir">Mirage</label>
          </div>
          <select id="brand" class="form-select d-none" required>
            <option value="infinity" selected>Infinity</option>
            <option value="mirage">Mirage</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Πάχος (mm) / Διαστάσεις</label>
          <div class="thdim-row">
            <div class="inline-block mb-2">
              <div class="btn-group w-100 pill-group scrollable" role="group" aria-label="Πάχος" id="thickness_group"></div>
            </div>
            <div class="inline-block">
              <div class="small text-muted mb-1 dim-label">Διαστάσεις</div>
              <div class="btn-group w-100 pill-group scrollable" role="group" aria-label="Διαστάσεις" id="dimensions_group"></div>
            </div>
          </div>
          <select id="variant" class="form-select d-none" required>
            <!-- options populated dynamically as e.g., 6 (160x320) -->
          </select>
          <input type="hidden" id="thickness" value="">
          <input type="hidden" id="dimensions" value="">
        </div>
        <div class="col-md-3">
          <label class="form-label d-flex align-items-center gap-2">Ποσότητα <span id="qty_mode_badge" class="badge rounded-pill text-bg-secondary" title="Τρόπος εισόδου">ΤΕΜ</span></label>
          <div class="input-group" id="qty_box">
            <button type="button" class="btn btn-outline-secondary active" id="mode_units" data-mode="units" aria-pressed="true">ΤΕΜ</button>
            <button type="button" class="btn btn-outline-secondary" id="mode_sqm" data-mode="sqm" aria-pressed="false">m²</button>
            <button class="btn btn-outline-secondary" type="button" id="qty_minus" aria-label="Μείωση"><i class="fas fa-minus"></i></button>
            <input type="number" id="qty_input" class="form-control text-end" placeholder="π.χ. 15" required>
            <button class="btn btn-outline-secondary" type="button" id="qty_plus" aria-label="Αύξηση"><i class="fas fa-plus"></i></button>
          </div>
          <!-- hidden mirrors to keep backend contract unchanged -->
          <input type="hidden" id="units" value="">
          <input type="hidden" id="qty_m2" value="">
          <div class="small text-muted mt-1" id="units_explain" style="display:none;"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Τιμή Αγοράς / m² (€)</label>
          <div class="input-group" id="buy_unit_group">
            <button class="btn btn-outline-secondary" type="button" data-step-target="#buy_price_eur_m2" data-step="-0.10" aria-label="Μείωση τιμής"><i class="fas fa-minus"></i></button>
            <input type="number" min="0" step="0.01" id="buy_price_eur_m2" class="form-control text-end" placeholder="π.χ. 100" required>
            <button class="btn btn-outline-secondary" type="button" data-step-target="#buy_price_eur_m2" data-step="0.10" aria-label="Αύξηση τιμής"><i class="fas fa-plus"></i></button>
            <span class="input-group-text unit-grey">€ / m²</span>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Προορισμός</label>
          <div class="btn-group w-100 pill-group" role="group" aria-label="Προορισμός" id="destination_group">
            <input type="radio" class="btn-check" name="destopt" id="dest_gr_main" autocomplete="off" data-value="GR-mainland" checked>
            <label class="btn btn-sm btn-outline-secondary" for="dest_gr_main">Ελλάδα - Αθήνα</label>
            <input type="radio" class="btn-check" name="destopt" id="dest_gr_crete" autocomplete="off" data-value="GR-crete">
            <label class="btn btn-sm btn-outline-secondary" for="dest_gr_crete">Ελλάδα - Κρήτη</label>
          </div>
          <select id="destination" class="form-select d-none">
            <option value="GR-mainland" selected>Ελλάδα - Αθήνα</option>
            <option value="GR-crete">Ελλάδα - Κρήτη</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Συσκευασία</label>
          <div class="btn-group w-100 pill-group" role="group" aria-label="Συσκευασία" id="packaging_group">
            <input type="radio" class="btn-check" name="pack" id="pack_auto" value="auto" checked>
            <label class="btn btn-sm btn-outline-secondary" for="pack_auto">Βέλτιστη Πρόταση</label>
            <input type="radio" class="btn-check" name="pack" id="pack_crate" value="crate">
            <label class="btn btn-sm btn-outline-secondary" for="pack_crate">Crate</label>
            <input type="radio" class="btn-check" name="pack" id="pack_aframe" value="a-frame">
            <label class="btn btn-sm btn-outline-secondary" for="pack_aframe">A-Frame</label>
          </div>
          <div class="small text-muted mt-1" id="pack_hint"></div>
        </div>
        <div class="col-md-4">
          <label for="margin" class="form-label">Περιθώριο (Margin %)</label>
          <input type="number" min="0" max="1" step="0.01" class="form-control d-none" id="margin" value="0.40" required>
          <div class="d-flex align-items-center gap-2">
            <input type="range" id="margin_range" class="form-range" min="0" max="1" step="0.01" value="0.40" aria-label="Περιθώριο (Margin %)">
            <span id="margin_badge" class="badge rounded-pill text-bg-success">40.00%</span>
          </div>
        </div>
        <div class="col-12">
          <button id="calcBtn" class="btn btn-calc" type="submit"><i class="fas fa-calculator me-2"></i>Υπολογισμός</button>
        </div>
      </form>

      <div id="result" class="mt-4" style="display:none;">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
              <div>
                <h5 class="card-title mb-1">Ανάλυση Κόστους</h5>
                <p class="text-muted mb-3">SLABs</p>
              </div>
              <div class="p-3 rounded retail-badge">
                <div class="small text-white-50">Λιανική Τιμή / m²</div>
                <div class="fw-bold" id="sell_per_m2" style="font-size: 1.6rem;">—</div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12 col-lg-6">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Κόστος Εμπορεύματος</span><strong id="cost_goods">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Χειρισμός Παλετών</span><strong id="pallet_handling">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Μεταφορικά Παλετών</span><strong id="pallet_shipping">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Μεταφορικά (Ιταλία)</span><strong id="freight">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Επιβάρυνση Κρήτης</span><strong id="gr_crete_extra">—</strong></li>
                  <li class="list-group-item py-2" id="gr_crete_extra_details" style="display:none;">
                    <div class="small text-muted">Ανάλυση Επιβάρυνσης Κρήτης</div>
                    <ul class="mb-0 small" id="gr_crete_extra_breakdown_list"></ul>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Σύνολο Logistics</span><strong id="logistics">—</strong></li>
                </ul>
              </div>
              <div class="col-12 col-lg-6">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Σύνολο Κόστους</span><strong id="total_cost">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Κόστος ανά m²</span><strong id="cost_per_m2">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Περιθώριο</span><strong id="margin_value">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Ισοδύναμο Markup</span><strong id="markup_equiv">—</strong></li>
                  <li class="list-group-item small"><code id="markup_formula">Sell = Cost / (1 - Margin) • Markup = Sell/Cost - 1</code></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Συνολ. Βάρος</span><strong id="kg_total">—</strong></li>
                  <li class="list-group-item d-flex justify-content-between align-items-center"><span>Παλέτες</span><strong id="pallets_info">—</strong></li>
                </ul>
                <div class="mt-3">
                  <h6 class="mb-2">Φόρτωση Παλετών</h6>
                  <div class="small text-muted mb-2">Οπτική απεικόνιση πληρότητας ανά παλέτα</div>
                  <div id="pallet_fill_container" class="d-flex flex-column gap-3 w-100"></div>
                  <div class="d-flex gap-3 mt-2 small">
                    <span><span class="badge rounded-pill bg-success">&nbsp;&nbsp;</span> ≥ 90% (κατάλληλη)</span>
                    <span><span class="badge rounded-pill bg-warning text-dark">&nbsp;&nbsp;</span> 40–90% (μέτρια)</span>
                    <span><span class="badge rounded-pill bg-danger">&nbsp;&nbsp;</span> < 40% (χαμηλή)</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  <script>
    toastr.options = { positionClass: 'toast-top-right', timeOut: 7000, closeButton: true, progressBar: true };

    const detailsUrl = '/pricing/slabs/details'; // not used now, we compute server-side

    const state = { data: null };

    // Simple renderer for pallet fill visualization
    function renderPalletFill(units, capacity, pallets, packType, breakdown){
      const container = document.getElementById('pallet_fill_container');
      if (!container) return;
      container.innerHTML = '';
      const cap = Math.max(1, Number(capacity||0));
      const totalPallets = Math.max(1, Number(pallets||0));
      const totalUnits = Math.max(0, Number(units||0));
      for (let i=0;i<totalPallets;i++){
        let cap_i = cap;
        let filled = 0;
        let type_i = packType || '';
        if (Array.isArray(breakdown) && breakdown[i]){
          const b = breakdown[i];
          cap_i = Math.max(1, Number(b.capacity||cap));
          filled = Math.max(0, Math.min(cap_i, Number(b.units||0)));
          type_i = String(b.type || type_i).toUpperCase();
        } else {
          const isLast = (i === totalPallets-1);
          filled = isLast ? (totalUnits - cap * (totalPallets-1)) : cap;
          if (filled < 0) filled = 0;
          if (filled > cap) filled = cap;
        }
        const pct = cap_i>0 ? (filled / cap_i) * 100 : 0;
        let color = 'bg-danger';
        if (pct >= 90) color = 'bg-success';
        else if (pct >= 40) color = 'bg-warning';
        const row = document.createElement('div');
        row.className = 'd-flex align-items-center gap-3';
        const label = document.createElement('div');
        label.style.minWidth = '140px';
        // Choose image by type
        const typeKey = (type_i || '').toLowerCase();
        let imgSrc = '';
        if (typeKey.includes('a-frame') || typeKey.includes('a frame') || typeKey.includes('aframe')) {
          imgSrc = '/images/A-FRAME.png';
        } else if (typeKey.includes('crate') || typeKey.includes('grate') || typeKey.includes('crate')) {
          imgSrc = '/images/CRATE.png';
        }
        const imgHtml = imgSrc ? `<img src="${imgSrc}" alt="${type_i}" style="height:36px;width:auto;object-fit:contain;vertical-align:middle;margin-right:8px;">` : '';
        label.innerHTML = `${imgHtml}<strong>Παλέτα ${i+1}</strong><div class="small text-muted">${type_i}</div>`;
        const shell = document.createElement('div');
        shell.className = 'progress flex-grow-1';
        shell.style.height = '20px';
        const bar = document.createElement('div');
        bar.className = `progress-bar ${color}`;
        bar.style.width = pct.toFixed(2)+'%';
        bar.setAttribute('aria-valuenow', pct.toFixed(2));
        bar.setAttribute('aria-valuemin','0');
        bar.setAttribute('aria-valuemax','100');
        bar.title = `${pct.toFixed(1)}%`;
        shell.appendChild(bar);
        const right = document.createElement('div');
        right.className = 'text-muted small';
        right.textContent = `${filled}/${cap_i} τεμ. (${pct.toFixed(0)}%)`;
        row.appendChild(label);
        row.appendChild(shell);
        row.appendChild(right);
        container.appendChild(row);
      }
    }

    // Fetch details for dynamic hints (we'll ask calc endpoint for suggestions instead)

    function updateThicknessOptions() {
      const brand = document.getElementById('brand').value;
      const select = document.getElementById('variant');
      const thHidden = document.getElementById('thickness');
      const dimHidden = document.getElementById('dimensions');
      const thGroup = document.getElementById('thickness_group');
      const dimGroup = document.getElementById('dimensions_group');
      // reset containers
      if (thGroup) thGroup.innerHTML = '';
      if (dimGroup) dimGroup.innerHTML = '';
      select.innerHTML = '';

      // Define variants inline (kept in sync with slab_details.json)
      const variants = brand === 'infinity'
        ? [
            {thickness:6, dimensions:'160x320'},
            {thickness:12, dimensions:'162x324'},
            {thickness:20, dimensions:'162x324'}
          ]
        : [
            {thickness:6, dimensions:'120x278'},
            {thickness:6, dimensions:'160x320'},
            {thickness:12, dimensions:'162x324'}
          ];

      // Populate hidden select for compatibility (not visible)
      variants.forEach(v => {
        const o = document.createElement('option');
        o.value = `${v.thickness}|${v.dimensions}`;
        o.textContent = `${v.thickness} (${v.dimensions})`;
        o.setAttribute('data-thickness', String(v.thickness));
        o.setAttribute('data-dimensions', v.dimensions);
        select.appendChild(o);
      });

      // Compact selection for Mirage: render combined options and hide dimensions block
      if (brand === 'mirage') {
        const dimBlock = dimGroup ? dimGroup.parentElement : null;
        if (dimBlock) dimBlock.style.display = 'none';
        if (thGroup) {
          thGroup.innerHTML = '';
          variants.forEach((v, idx) => {
            const id = `mir_${v.thickness}_${String(v.dimensions).replace(/[^a-zA-Z0-9]/g,'')}_${idx}`;
            const input = document.createElement('input');
            input.type = 'radio';
            input.className = 'btn-check';
            input.name = 'thopt';
            input.id = id;
            input.setAttribute('data-th', String(v.thickness));
            input.setAttribute('data-dim', v.dimensions);
            input.setAttribute('autocomplete','off');
            if (idx === 0) input.checked = true;
            const label = document.createElement('label');
            label.className = 'btn btn-sm btn-outline-secondary';
            label.setAttribute('for', id);
            const showLabel = v.thickness === 12 ? '12 mm' : `${v.thickness} mm ${v.dimensions}`;
            label.textContent = showLabel;
            input.addEventListener('change', () => {
              if (input.checked) {
                const th = parseInt(input.getAttribute('data-th')||'0',10) || v.thickness;
                const dim = input.getAttribute('data-dim') || v.dimensions;
                thHidden.value = String(th);
                dimHidden.value = dim;
                select.value = `${th}|${dim}`;
                select.dispatchEvent(new Event('change'));
                thHidden.dispatchEvent(new Event('change'));
              }
            });
            thGroup.appendChild(input);
            thGroup.appendChild(label);
          });
          // Set initial defaults and dispatch events
          const first = variants[0];
          if (first) {
            thHidden.value = String(first.thickness);
            dimHidden.value = first.dimensions;
            select.value = `${first.thickness}|${first.dimensions}`;
            select.dispatchEvent(new Event('change'));
            thHidden.dispatchEvent(new Event('change'));
          }
        }
        return;
      }

      // Build unique thickness list preserving order
      const thicknesses = [];
      variants.forEach(v => { if (!thicknesses.includes(v.thickness)) thicknesses.push(v.thickness); });

      // Helper to render dimensions for a selected thickness
      function renderDimensionsFor(th) {
        if (!dimGroup) return;
        dimGroup.innerHTML = '';
        const dims = variants.filter(v => v.thickness === th).map(v => v.dimensions);

        // Show Διαστάσεις only when there is an actual choice (e.g., Mirage + 6mm)
        const dimBlock = dimGroup.parentElement; // wraps label + group
        if (dimBlock) {
          if (dims.length <= 1) {
            dimBlock.style.display = 'none';
          } else {
            dimBlock.style.display = 'block';
          }
        }

        dims.forEach((dim, idx) => {
          const id = `dim_${th}_${idx}`;
          const input = document.createElement('input');
          input.type = 'radio';
          input.className = 'btn-check';
          input.name = 'dimsopt';
          input.id = id;
          input.setAttribute('data-dim', dim);
          input.setAttribute('autocomplete', 'off');
          if (idx === 0) input.checked = true;
          const label = document.createElement('label');
          label.className = 'btn btn-sm btn-outline-secondary';
          label.setAttribute('for', id);
          label.textContent = dim;
          input.addEventListener('change', () => {
            if (input.checked) {
              thHidden.value = String(th);
              dimHidden.value = dim;
              // sync hidden select value too
              select.value = `${th}|${dim}`;
              select.dispatchEvent(new Event('change'));
              // notify for packaging proposal
              thHidden.dispatchEvent(new Event('change'));
            }
          });
          dimGroup.appendChild(input);
          dimGroup.appendChild(label);
        });
        // Set hidden to first by default (works even when the UI is hidden)
        const firstDim = dims[0];
        if (firstDim) {
          thHidden.value = String(th);
          dimHidden.value = firstDim;
          select.value = `${th}|${firstDim}`;
          select.dispatchEvent(new Event('change'));
          thHidden.dispatchEvent(new Event('change'));
        }
      }

      // Render thickness group
      if (thGroup) {
        thicknesses.forEach((th, idx) => {
          const id = `th_${th}`;
          const input = document.createElement('input');
          input.type = 'radio';
          input.className = 'btn-check';
          input.name = 'thopt';
          input.id = id;
          input.setAttribute('data-th', String(th));
          input.setAttribute('autocomplete', 'off');
          if (idx === 0) input.checked = true;
          const label = document.createElement('label');
          label.className = 'btn btn-sm btn-outline-secondary';
          label.setAttribute('for', id);
          label.textContent = `${th} mm`;
          input.addEventListener('change', () => {
            if (input.checked) {
              const selTh = parseInt(input.getAttribute('data-th') || '0', 10) || th;
              renderDimensionsFor(selTh);
            }
          });
          thGroup.appendChild(input);
          thGroup.appendChild(label);
        });
        // initial render
        if (thicknesses.length) {
          renderDimensionsFor(thicknesses[0]);
        }
      }
    }

    // Keep hidden thickness/dimensions in sync with selected variant
    document.addEventListener('change', function(e){
      var target = e.target;
      if (target && target.id === 'variant'){
        var sel = target;
        var opt = sel.selectedOptions && sel.selectedOptions[0];
        if (opt){
          document.getElementById('thickness').value = opt.getAttribute('data-thickness') || '';
          document.getElementById('dimensions').value = opt.getAttribute('data-dimensions') || '';
          // trigger packaging proposal listeners
          try { document.getElementById('thickness').dispatchEvent(new Event('change')); } catch(e) {}
        }
      }
    });

    function setPackHint(text){ document.getElementById('pack_hint').textContent = text || ''; }

    async function proposePackaging() {
      const brand = document.getElementById('brand').value;
      const thickness = parseInt(document.getElementById('thickness').value || '0');
      const dimensions = document.getElementById('dimensions').value || '';
      const mode = getQtyMode();
      const qtyVal = parseFloat(document.getElementById('qty_input').value || '0');
      const units = mode==='units' ? Math.round(qtyVal) : 0;
      const qty_m2 = mode==='sqm' ? qtyVal : 0;
      if ((!thickness) || (mode==='units' ? !(units>0) : !(qty_m2>0))) { setPackHint(''); return; }
      try {
        const payload = (mode==='units')
          ? { brand, thickness, dimensions, units, buy_price_eur_m2: 0, pack: 'auto' }
          : { brand, thickness, dimensions, qty_m2, input_mode: 'sqm', buy_price_eur_m2: 0, pack: 'auto' };
        const res = await fetch('/api/pricing/slabs/calc', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!res.ok) return;
        const data = await res.json();
        setPackHint(`Βέλτιστη πρόταση: ${data.selection.package_type.toUpperCase()} – ${data.selection.pallets} παλέτα/ες`);
        // Show conversion explanation when m² used
        const explainBox = document.getElementById('units_explain');
        if (mode==='sqm' && data && data.conversion && data.conversion.text) {
          explainBox.textContent = `Τεμάχια για παραγγελία: ${Number(data.inputs.units||0)}. ${data.conversion.text}`;
          explainBox.style.display = 'block';
        } else {
          explainBox.textContent = '';
          explainBox.style.display = 'none';
        }
        // Tick auto if present
        document.getElementById('pack_auto').checked = true;
      } catch(e) { /* ignore */ }
    }

    document.addEventListener('DOMContentLoaded', function(){
      updateThicknessOptions();
      document.getElementById('brand').addEventListener('change', updateThicknessOptions);
      document.getElementById('thickness').addEventListener('change', proposePackaging);
      document.getElementById('units').addEventListener('input', proposePackaging);

      // Stepper buttons (match pricing page behavior)
      document.querySelectorAll('[data-step-target]').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetSel = btn.getAttribute('data-step-target');
          const step = parseFloat(btn.getAttribute('data-step') || '0');
          const input = document.querySelector(targetSel);
          if (!input) return;
          const current = parseFloat(input.value || '0') || 0;
          const next = current + step;
          const min = input.min !== '' ? parseFloat(input.min) : undefined;
          const max = input.max !== '' ? parseFloat(input.max) : undefined;
          let val = isFinite(next) ? next : current;
          if (min !== undefined && val < min) val = min;
          if (max !== undefined && val > max) val = max;
          const st = parseFloat(input.step || '1');
          if (st && isFinite(st)) { val = Math.round(val / st) * st; }
          input.value = (input.step && parseFloat(input.step) < 1) ? val.toFixed(2) : String(Math.round(val));
          input.dispatchEvent(new Event('input'));
          input.dispatchEvent(new Event('change'));
        });
      });

      // Visual validation like pricing: required fields red until valid
      const calcBtn = document.getElementById('calcBtn');
      const qtyBox = document.getElementById('qty_box');
      const qtyInput = document.getElementById('qty_input');
      const qtyMinus = document.getElementById('qty_minus');
      const qtyPlus = document.getElementById('qty_plus');
      const modeUnitsBtn = document.getElementById('mode_units');
      const modeSqmBtn = document.getElementById('mode_sqm');
      const qtySuffix = document.getElementById('qty_unit_suffix');
      let currentQtyMode = 'units';
      function getQtyMode(){ return currentQtyMode; }
      function setQtyMode(mode){
        currentQtyMode = (mode==='sqm') ? 'sqm' : 'units';
        if (modeUnitsBtn && modeSqmBtn){
          const isUnits = currentQtyMode==='units';
          modeUnitsBtn.classList.toggle('active', isUnits);
          modeUnitsBtn.setAttribute('aria-pressed', String(isUnits));
          modeUnitsBtn.classList.toggle('btn-secondary', isUnits);
          modeUnitsBtn.classList.toggle('btn-outline-secondary', !isUnits);
          modeSqmBtn.classList.toggle('active', !isUnits);
          modeSqmBtn.setAttribute('aria-pressed', String(!isUnits));
          modeSqmBtn.classList.toggle('btn-secondary', !isUnits);
          modeSqmBtn.classList.toggle('btn-outline-secondary', isUnits);
        }
        if (qtySuffix) qtySuffix.textContent = currentQtyMode==='units' ? 'unit' : 'm²';
        if (qtyInput){
          qtyInput.value = '';
          qtyInput.min = currentQtyMode==='units' ? '1' : '0.01';
          qtyInput.step = currentQtyMode==='units' ? '1' : '0.01';
          qtyInput.placeholder = currentQtyMode==='units' ? 'π.χ. 15' : 'π.χ. 16.50';
        }
        // Update visible mode badge near label
        const badge = document.getElementById('qty_mode_badge');
        if (badge){
          if (currentQtyMode==='units'){
            badge.textContent = 'ΤΕΜ';
            badge.classList.remove('text-bg-info');
            badge.classList.add('text-bg-secondary');
          } else {
            badge.textContent = 'm²';
            badge.classList.remove('text-bg-secondary');
            badge.classList.add('text-bg-info');
          }
        }
        refreshQtyState();
        refreshCalcButtonState();
        proposePackaging();
      }
      [modeUnitsBtn, modeSqmBtn].forEach(btn => {
        if (!btn) return;
        btn.addEventListener('click', (ev)=>{ ev.preventDefault(); const m = btn.getAttribute('data-mode'); setQtyMode(m||'units'); });
      });
      // initialize
      setQtyMode('units');
      function stepQty(delta){
        const st = currentQtyMode==='units' ? 1 : 0.10;
        let v = parseFloat(qtyInput.value||'0')||0;
        v = v + delta*st;
        const min = parseFloat(qtyInput.min||'0');
        if (v < min) v = min;
        if (currentQtyMode==='units') v = Math.round(v); else v = Math.round(v*100)/100;
        qtyInput.value = currentQtyMode==='units' ? String(v) : v.toFixed(2);
        qtyInput.dispatchEvent(new Event('input'));
        qtyInput.dispatchEvent(new Event('change'));
      }
      if (qtyMinus) qtyMinus.addEventListener('click', ()=> stepQty(-1));
      if (qtyPlus) qtyPlus.addEventListener('click', ()=> stepQty(1));
      function isQuantityValid(){ const v = parseFloat(qtyInput.value); return currentQtyMode==='units' ? (Number.isFinite(v) && v >= 1) : (Number.isFinite(v) && v >= 0.01); }
      function refreshQtyState(){ const valid = isQuantityValid(); if (qtyInput){ qtyInput.setAttribute('aria-invalid', String(!valid)); } if (qtyBox){ qtyBox.classList.toggle('validation-invalid', !valid); qtyBox.classList.toggle('validation-valid', valid); } }
      qtyInput.addEventListener('input', ()=>{ refreshQtyState(); refreshCalcButtonState(); });
      qtyInput.addEventListener('change', ()=>{ refreshQtyState(); refreshCalcButtonState(); });

      const buyUnitInput = document.getElementById('buy_price_eur_m2');
      const buyUnitGroup = document.getElementById('buy_unit_group');
      function isBuyUnitValid(){ const v = parseFloat(buyUnitInput.value); const min = buyUnitInput.min!==''?parseFloat(buyUnitInput.min):0; return Number.isFinite(v) && v >= min; }
      function refreshBuyUnitState(){ const valid = isBuyUnitValid(); buyUnitInput.setAttribute('aria-invalid', String(!valid)); if (buyUnitGroup){ buyUnitGroup.classList.toggle('validation-invalid', !valid); buyUnitGroup.classList.toggle('validation-valid', valid); } }
      buyUnitInput.addEventListener('input', refreshBuyUnitState); buyUnitInput.addEventListener('change', refreshBuyUnitState); refreshBuyUnitState();

      // Margin slider sync (ensure declared before any references)
      const marginNumber = document.getElementById('margin');
      const marginRange = document.getElementById('margin_range');
      const marginBadge = document.getElementById('margin_badge');
      function updateMarginFromRange(){
        const v = parseFloat(marginRange.value);
        marginNumber.value = v.toFixed(2);
        const pct = v*100;
        marginBadge.textContent = pct.toFixed(2)+"%";
        const classes = ['text-bg-danger','text-bg-warning','text-bg-secondary','text-bg-success'];
        classes.forEach(c=>marginBadge.classList.remove(c));
        if (pct < 30) marginBadge.classList.add('text-bg-danger');
        else if (pct < 40) marginBadge.classList.add('text-bg-warning');
        else if (pct <= 50) marginBadge.classList.add('text-bg-secondary');
        else marginBadge.classList.add('text-bg-success');
      }
      if (marginRange && marginNumber){
        marginRange.addEventListener('input', updateMarginFromRange);
        marginRange.addEventListener('change', updateMarginFromRange);
        updateMarginFromRange();
      }

      // Calc button state (red by default, green when inputs valid and margin inside (0,1))
      function isMarginValid(){ const m = parseFloat(document.getElementById('margin').value || '0'); return Number.isFinite(m) && m > 0 && m < 1; }
      function refreshCalcButtonState(){ try { const allValid = isQuantityValid() && isBuyUnitValid() && isMarginValid(); if (calcBtn){ calcBtn.classList.toggle('is-valid', allValid); calcBtn.classList.toggle('is-invalid', !allValid); calcBtn.setAttribute('aria-pressed', String(allValid)); } } catch(e){} }
      // wire to inputs
      qtyInput.addEventListener('input', refreshCalcButtonState); qtyInput.addEventListener('change', refreshCalcButtonState);
      buyUnitInput.addEventListener('input', refreshCalcButtonState); buyUnitInput.addEventListener('change', refreshCalcButtonState);
      if (marginRange){ marginRange.addEventListener('input', refreshCalcButtonState); marginRange.addEventListener('change', refreshCalcButtonState); }
      // initialize on load
      refreshCalcButtonState();

      function wireToggleGroup(groupId, selectId) {
        const group = document.getElementById(groupId);
        const select = document.getElementById(selectId);
        if (!group || !select) return;
        group.querySelectorAll('input[type="radio"]').forEach(radio => {
          radio.addEventListener('change', () => {
            if (radio.checked) {
              const val = radio.getAttribute('data-value');
              if (val) {
                select.value = val;
                select.dispatchEvent(new Event('change'));
              }
            }
          });
        });
        const current = select.value;
        const match = group.querySelector(`input[data-value="${current}"]`);
        if (match) {
          match.checked = true;
          match.dispatchEvent(new Event('change'));
        }
      }
      wireToggleGroup('destination_group','destination');
      wireToggleGroup('brand_group','brand');

      // Quantity mode is now selected from the dropdown inside the input group; initialization done above.

      document.getElementById('slabForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const brand = document.getElementById('brand').value;
        const thickness = parseInt(document.getElementById('thickness').value || '0');
        const dimensions = document.getElementById('dimensions').value || '';
        const mode = getQtyMode();
        const qtyVal = parseFloat(document.getElementById('qty_input').value || '0');
        const units = mode==='units' ? Math.round(qtyVal) : 0;
        const qty_m2 = mode==='sqm' ? qtyVal : 0;
        const buy_price_eur_m2 = parseFloat(document.getElementById('buy_price_eur_m2').value || '0');
        const pack = (document.querySelector('input[name="pack"]:checked') && document.querySelector('input[name="pack"]:checked').value) || 'auto';

        if (!(isQuantityValid()) || !(buy_price_eur_m2>=0)) { toastr.error('Συμπληρώστε σωστά τα πεδία.'); return; }
        try{
          const destination = document.getElementById('destination').value;
          const margin = parseFloat(document.getElementById('margin').value || '0.40');
          if (!(margin>0 && margin<1)) { toastr.error('Το περιθώριο πρέπει να είναι μεταξύ 0 και 1 (π.χ. 0.40)'); return; }
          const body = (mode==='units') ? { brand, thickness, dimensions, units, buy_price_eur_m2, pack, destination, margin } : { brand, thickness, dimensions, qty_m2, input_mode: 'sqm', buy_price_eur_m2, pack, destination, margin };
          const res = await fetch('/api/pricing/slabs/calc', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if (!res.ok) {
            const err = await res.json().catch(()=>({detail:'Σφάλμα'}));
            throw new Error(err.detail || 'Αποτυχία αιτήματος');
          }
          const data = await res.json();
          const euro = (v)=> `${Number(v).toFixed(2)} €`;
          document.getElementById('cost_goods').textContent = euro(data.cost.cost_goods);
          document.getElementById('pallet_handling').textContent = euro(data.cost.pallet_handling);
          document.getElementById('pallet_shipping').textContent = euro(data.cost.pallet_shipping);
          document.getElementById('freight').textContent = euro(data.cost.freight_it);
          const detailsBox = document.getElementById('gr_crete_extra_details');
          const listBox = document.getElementById('gr_crete_extra_breakdown_list');
          if (typeof data.cost.gr_crete_extra !== 'undefined' && data.cost.gr_crete_extra !== null) {
            document.getElementById('gr_crete_extra').textContent = euro(data.cost.gr_crete_extra);
            // render breakdown if available
            if (Array.isArray(data.cost.gr_crete_extra_breakdown) && data.cost.gr_crete_extra_breakdown.length) {
              if (listBox) {
                listBox.innerHTML = '';
                data.cost.gr_crete_extra_breakdown.forEach(item => {
                  const li = document.createElement('li');
                  const type = String(item.type || '').toUpperCase();
                  const pallets = Number(item.pallets || 0);
                  const rate = Number(item.rate || 0);
                  const amount = Number(item.amount || 0);
                  li.textContent = `${type} × ${pallets} @ ${euro(rate)} = ${euro(amount)}`;
                  listBox.appendChild(li);
                });
              }
              if (detailsBox) detailsBox.style.display = 'block';
            } else {
              if (detailsBox) detailsBox.style.display = 'none';
              if (listBox) listBox.innerHTML = '';
            }
          } else {
            document.getElementById('gr_crete_extra').textContent = '—';
            if (detailsBox) detailsBox.style.display = 'none';
            if (listBox) listBox.innerHTML = '';
          }
          document.getElementById('logistics').textContent = euro(data.cost.logistics);
          document.getElementById('total_cost').textContent = euro(data.cost.total_cost);
          document.getElementById('cost_per_m2').textContent = euro(data.cost.cost_per_m2);
          document.getElementById('kg_total').textContent = `${data.weights.kg_total} kg`;
          const mix = data?.selection?.package_mix;
          if (mix) {
            const by = data.selection.pallets_by_type||{};
            const c = Number(by['crate']||0);
            const a = Number(by['a-frame']||0);
            document.getElementById('pallets_info').textContent = `Σύνολο ${data.selection.pallets} (A-FRAME × ${a}, CRATE × ${c})`;
          } else {
            document.getElementById('pallets_info').textContent = `${data.selection.package_type.toUpperCase()} × ${data.selection.pallets}`;
          }
          document.getElementById('sell_per_m2').textContent = euro(data.pricing.sell_price_per_m2);
          // Show conversion explanation when m² used
          const explainBox2 = document.getElementById('units_explain');
          if ((data?.inputs?.input_mode||'') === 'sqm' && data?.conversion?.text) {
            explainBox2.textContent = `Τεμάχια για παραγγελία: ${Number(data.inputs.units||0)}. ${data.conversion.text}`;
            explainBox2.style.display = 'block';
          } else {
            explainBox2.textContent = '';
            explainBox2.style.display = 'none';
          }
          // margin and markup
          if (typeof data.pricing.margin === 'number') {
            document.getElementById('margin_value').textContent = `${(data.pricing.margin*100).toFixed(2)}%`;
          } else { document.getElementById('margin_value').textContent = '—'; }
          if (typeof data.pricing.markup_equiv === 'number') {
            document.getElementById('markup_equiv').textContent = `${(data.pricing.markup_equiv*100).toFixed(2)}%`;
          } else { document.getElementById('markup_equiv').textContent = '—'; }
          const cp2 = Number(data?.cost?.cost_per_m2||0); const sp2 = Number(data?.pricing?.sell_price_per_m2||0);
          if (cp2>0 && sp2>0) {
            document.getElementById('markup_formula').textContent = `Sell = ${sp2.toFixed(2)} = Cost / (1 - Margin) = ${cp2.toFixed(2)} / (1 - ${(data.pricing.margin*100).toFixed(2)}%) • Markup = Sell/Cost - 1 = ${(sp2/cp2-1).toFixed(4)} (${((sp2/cp2-1)*100).toFixed(2)}%)`;
          } else {
            document.getElementById('markup_formula').textContent = 'Sell = Cost / (1 - Margin) • Markup = Sell/Cost - 1';
          }

          // Pallet fill visualization
          try {
            const units = Number(data?.inputs?.units || 0);
            const cap = Number(data?.selection?.capacity_per_palette || 0);
            const pallets = Number(data?.selection?.pallets || 0);
            const type = String(data?.selection?.package_type || '').toUpperCase();
            const breakdown = Array.isArray(data?.selection?.breakdown) ? data.selection.breakdown : null;
            renderPalletFill(units, cap, pallets, type, breakdown);
          } catch (e) { /* ignore */ }

          const resultEl = document.getElementById('result');
          resultEl.style.display = 'block';
          try { resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e) { /* no-op */ }
          if (Array.isArray(data.warnings) && data.warnings.length) {
            data.warnings.forEach(w => toastr.warning(w));
          } else { toastr.success('Υπολογισμός ολοκληρώθηκε'); }
          // After successful calculation, keep validation/Calc button state consistent
          try { refreshUnitsState(); refreshBuyUnitState(); refreshCalcButtonState(); } catch(e) { /* noop */ }
        } catch(err){ toastr.error(err.message || 'Σφάλμα υπολογισμού'); }
      });

      // initial proposal
      proposePackaging();
    });
  </script>
  <script>
    // Ensure current year in footer
    document.addEventListener('DOMContentLoaded', function(){
      var el = document.getElementById('currentYear');
      if (el) el.textContent = new Date().getFullYear();
    });
  </script>

  <!-- Footer -->
  <footer class="mt-5 pt-5 text-center">
    <div class="container-fluid">
      <div class="py-4 border-top">
        <div class="row align-items-center">
          <div class="col-md-4 text-md-start mb-3 mb-md-0">
            <a href="/" class="d-inline-flex align-items-center text-decoration-none">
              <img src="/images/mylogo.png" alt="Softone ERP Logo" height="30" class="me-2">
              <span class="fw-bold" style="color: #0f172a;">Corgres Σταγάκης</span>
            </a>
          </div>
          <div class="col-md-4 mb-3 mb-md-0">
            <p class="text-muted mb-0">
              <i class="fas fa-heart fa-beat" style="color: var(--primary-color);"></i> Made with care
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <p class="text-muted mb-0">
              &copy; <span id="currentYear"></span> Ioannis E. Kommas. All rights Reserved
            </p>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    // Theme toggle
    try{
      var key='theme';
      var root=document.documentElement; var saved=localStorage.getItem(key);
      if(saved){ root.setAttribute('data-theme', saved); }
      document.getElementById('themeToggle') && document.getElementById('themeToggle').addEventListener('click', function(){
        var curr=root.getAttribute('data-theme')==='dark'?'light':'dark';
        root.setAttribute('data-theme', curr); localStorage.setItem(key, curr);
      });
    }catch(e){}

    // Presence (requires existing /ws/app-status)
    var elCount=document.getElementById('presenceCount');
    var elList=document.getElementById('presenceList');
    var state={ apps:{}, visitors:[] };
    function render(){
      try{
        var total=new Set(Object.values(state.apps||{}).flat()).size;
        if(elCount) elCount.textContent=(total||0)+" online";
        if(elList) elList.innerHTML=(state.visitors||[]).map(function(v){
          var ip=v.ip||''; var br=(v.browsers||[]).join(', ');
          var vid=(v.visitorId||'').slice(0,8);
          var dtype=(v.deviceModel||v.deviceType||'');
          var dev=(dtype + (v.os? ' '+v.os:'')).trim();
          var net=v.net||'';
          var right=[br, dev].filter(Boolean).join(' · ');
          return '<div class="d-flex justify-content-between align-items-center py-1 border-bottom">\
            <div><span class="fw-semibold">'+vid+'</span> <span class="text-muted ms-1">'+ip+'</span>'+(net? ' <span class="text-muted">· '+net+'</span>':'')+'</div>\
            <div class="text-muted">'+right+'</div>\
          </div>';
        }).join('');
      }catch(e){}
    }
    function getVisitorId(){ try{ var id=localStorage.getItem('visitorId'); if(!id){ id='visitor_'+Math.random().toString(36).substr(2,9)+'_'+Date.now(); localStorage.setItem('visitorId', id);} return id;}catch(e){ return 'visitor_fallback_'+Date.now(); } }
    function getBrowserInfo(){ var ua=navigator.userAgent||navigator.vendor||window.opera; var platform=navigator.platform||''; var maxTP=(typeof navigator.maxTouchPoints==='number')?navigator.maxTouchPoints:0; var name=ua.indexOf('Firefox')>-1?'Firefox': ua.indexOf('SamsungBrowser')>-1?'Samsung Browser': ua.indexOf('OPR')>-1||ua.indexOf('Opera')>-1?'Opera': ua.indexOf('Trident')>-1?'Internet Explorer': ua.indexOf('Edg')>-1||ua.indexOf('Edge')>-1?'Edge': ua.indexOf('Chrome')>-1?'Chrome': ua.indexOf('Safari')>-1?'Safari':'Unknown'; var isIpad=/iPad/i.test(ua)||(platform==='MacIntel'&&maxTP>1); var isIphone=/iPhone/i.test(ua); var isIpod=/iPod/i.test(ua); var isAndroid=/Android/i.test(ua); var isIOS=isIphone||isIpad||isIpod; var os=(function(u){ if(isIOS) return 'iOS'; if(/Windows NT/i.test(u)) return 'Windows'; if(isAndroid) return 'Android'; if(/Macintosh|Mac OS X/i.test(u)) return 'macOS'; if(/Linux/i.test(u)) return 'Linux'; return 'Other'; })(ua); var deviceType=(function(u){ if(isIphone||isIpod) return 'Phone'; if(isIpad) return 'Tablet'; if(isAndroid) return (/Mobi|Mobile/i.test(u)?'Phone':'Tablet'); return 'PC'; })(ua); var deviceModel=isIphone?'iPhone':(isIpad?'iPad':(isIpod?'iPod':'')); return {browser:name, userAgent:ua, platform:navigator.platform, os:os, deviceType:deviceType, deviceModel:deviceModel}; }
    function getTabId(){ try{ var id=sessionStorage.getItem('tabId'); if(!id){ id='tab_'+Math.random().toString(36).substr(2,9)+'_'+Date.now(); sessionStorage.setItem('tabId', id);} return id;}catch(e){ return 'tab_fallback_'+Date.now(); } }
    var socket; var visitorId=getVisitorId(); var browserInfo=getBrowserInfo(); var tabId=getTabId(); var heartbeatInterval;
    function startHeartbeat(){ stopHeartbeat(); heartbeatInterval=setInterval(function(){ if(socket && socket.readyState===WebSocket.OPEN){ socket.send(JSON.stringify({action:'heartbeat', visitorId:visitorId, tabId:tabId})); } else { stopHeartbeat(); } }, 15000); }
    function stopHeartbeat(){ if(heartbeatInterval){ clearInterval(heartbeatInterval); heartbeatInterval=null; } }
    function connect(){ var protocol=location.protocol==='https:'?'wss:':'ws:'; socket=new WebSocket(protocol+'//'+location.host+'/ws/app-status');
      socket.addEventListener('open', function(){ try{ socket.send(JSON.stringify({action:'identify', visitorId:visitorId, browserInfo:browserInfo, tabId:tabId})); socket.send(JSON.stringify({action:'join', app:'retail-pricing', visitorId:visitorId, tabId:tabId})); startHeartbeat(); }catch(e){} });
      socket.addEventListener('message', function(evt){ try{ var data=JSON.parse(evt.data); if(data.type==='presence'){ state.apps=data.apps||{}; state.visitors=data.visitors||[]; render(); } else if(data.active_users){ state.apps=data.active_users; render(); } }catch(e){} });
      socket.addEventListener('close', function(){ stopHeartbeat(); setTimeout(connect, 5000); });
      socket.addEventListener('error', function(){ stopHeartbeat(); });
    }
    connect();
  })();
  </script>
</body>
</html>