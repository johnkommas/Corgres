<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Οργανόγραμμα Εταιρίας - Corgres Hub">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#e11d48">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f172a">
    <title>Οργανόγραμμα Εταιρίας | Corgres</title>
    <link rel="icon" type="image/png" href="/images/mylogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/hr/css/org-chart.css">
</head>
<body>
    <!-- Header (match slabs navbar) -->
    <nav class="navbar navbar-expand-lg navbar-light mb-4 py-3">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/images/mylogo.png" alt="Corgres" height="36">
                <span class="fw-bold ms-2" style="color: var(--dark-color);">Corgres Σταγάκης</span>
                <span class="text-muted d-none d-md-inline mx-2">|</span>
                <span class="text-muted d-none d-md-inline">Οργανόγραμμα</span>
            </a>
            <div class="ms-auto d-flex align-items-center gap-2">
                <button id="themeToggle" class="btn btn-sm btn-outline-secondary" type="button" title="Toggle theme">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <div id="presenceChip" class="presence-chip">
                    <span class="badge bg-success" id="presenceCount" role="button" data-bs-toggle="collapse" data-bs-target="#presencePanel" aria-expanded="false">0 online</span>
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#presencePanel" aria-expanded="false" title="Show online">
                        <i class="fa-solid fa-users"></i>
                    </button>
                </div>
                <a class="btn btn-outline-secondary d-none d-lg-inline" href="/"><i class="fas fa-home fa-fw me-2"></i>Home</a>
                <a class="btn btn-outline-secondary d-none d-lg-inline" href="/logs"><i class="fas fa-list-alt fa-fw me-2"></i>Logs</a>
            </div>
        </div>
    </nav>

    <!-- Presence panel (match slabs) -->
    <div class="collapse position-absolute end-0 mt-2" id="presencePanel" style="min-width: 320px; z-index: 1050;">
        <div class="card shadow-sm">
            <div class="card-body p-2"><div id="presenceList" class="small"></div></div>
        </div>
    </div>

    <main class="container-fluid my-4">
        <!-- Controls -->
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
            <div class="btn-group" role="group" aria-label="Εναλλαγή Καταστήματος">
                <button id="hqInfoBtn" class="btn btn-outline-primary"><i class="fa-solid fa-building-columns me-2"></i>Γενική Διεύθυνση</button>
                <button class="btn btn-outline-primary active" data-branch="Ρέθυμνο"><i class="fa-solid fa-building me-2"></i>Ρέθυμνο</button>
                <button class="btn btn-outline-primary" data-branch="Χανιά"><i class="fa-solid fa-store me-2"></i>Χανιά</button>
                <button class="btn btn-outline-primary" data-branch="Μενίδι"><i class="fa-solid fa-store me-2"></i>Μενίδι</button>
                <button class="btn btn-outline-primary" data-branch="Ασπρόπυργος"><i class="fa-solid fa-warehouse me-2"></i>Ασπρόπυργος</button>
            </div>
            <div id="rethymnoDeptFilter" class="btn-group d-none" role="group" aria-label="Τμήματα Ρεθύμνου">
                <button class="btn btn-outline-secondary" data-dept="Υπεύθυνος Λογιστηρίου">Υπεύθυνος Λογιστηρίου</button>
                <button class="btn btn-outline-secondary" data-dept="Υπεύθυνος Πωλήσεων">Υπεύθυνος Πωλήσεων</button>
                <button class="btn btn-outline-secondary" data-dept="Διευθυντής Αγορών">Διευθυντής Αγορών</button>
                <button class="btn btn-outline-secondary" data-dept="Υπεύθυνος Αποθήκης & Logistics">Υπεύθυνος Αποθήκης & Logistics</button>
                <button class="btn btn-outline-secondary" data-dept="Υπεύθυνος Παραγωγής">Υπεύθυνος Παραγωγής</button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button id="expandAll" class="btn btn-light"><i class="fa-solid fa-plus me-2"></i>Άνοιγμα όλων</button>
                <button id="collapseAll" class="btn btn-light"><i class="fa-solid fa-minus me-2"></i>Κλείσιμο όλων</button>
            </div>
        </div>

        <!-- Layout: Chart + Info Panel -->
        <div class="row g-3">
            <div class="col-12 col-lg-9 col-xl-9">
                <div id="orgchart" class="orgchart" aria-label="Οργανόγραμμα"></div>
            </div>
            <div class="col-12 col-lg-3 col-xl-3">
                <aside class="info-panel" aria-live="polite">
                    <div class="info-panel-header d-flex align-items-center justify-content-between">
                        <h2 class="h5 mb-0"><i class="fa-solid fa-circle-info me-2"></i>Πληροφορίες Ρόλου</h2>
                        <button id="clearInfo" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="roleDetails" class="info-content">
                        <p class="text-muted mb-0">Επιλέξτε έναν ρόλο για να εμφανιστούν οι λεπτομέρειες εδώ. Θα προστεθούν περιγραφές για κάθε ρόλο.</p>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- Footer (shared like pricing pages) -->
    <footer class="mt-5 pt-5 text-center">
        <div class="container-fluid">
            <div class="py-4 border-top">
                <div class="row align-items-center">
                    <div class="col-md-4 text-md-start mb-3 mb-md-0">
                        <a href="/" class="d-inline-flex align-items-center text-decoration-none">
                            <img src="/images/mylogo.png" alt="Softone ERP Logo" height="30" class="me-2">
                            <span class="fw-bold" style="color: var(--dark-color);">Corgres Σταγάκης</span>
                        </a>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <p class="text-muted mb-0">
                            <i class="fas fa-heart heart-pulse" style="color: var(--primary-color);"></i> Made with care
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <p class="text-muted mb-0">
                            &copy; <span id="currentYear"></span> Ioannis E. Kommas. All rights Reserved
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Charts loader for OrgChart -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="/hr/js/org-chart.js"></script>
    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
    <script>
    (function(){
      // Theme toggle with system preference and persistence (align to index/slabs)
      try{
        var key='theme';
        var root=document.documentElement; var saved=localStorage.getItem(key);
        var mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        function applyTheme(val){ if(val!=='dark'&&val!=='light'){ val='light'; } root.setAttribute('data-theme', val); }
        if(saved){ applyTheme(saved); } else { applyTheme(mq&&mq.matches?'dark':'light'); if(mq){ if(typeof mq.addEventListener==='function'){ mq.addEventListener('change', function(e){ applyTheme(e.matches?'dark':'light'); }); } else if(typeof mq.addListener==='function'){ mq.addListener(function(e){ applyTheme(e.matches?'dark':'light'); }); } } }
        var btn=document.getElementById('themeToggle');
        if(btn){ btn.addEventListener('click', function(){ var curr=root.getAttribute('data-theme')==='dark'?'light':'dark'; applyTheme(curr); localStorage.setItem(key, curr); var icon=btn.querySelector('i'); if(icon){ icon.classList.toggle('fa-moon', curr!=='dark'); icon.classList.toggle('fa-sun', curr==='dark'); } }); }
      }catch(e){}

      // Presence (same pattern as slabs) + ensure row click navigates to logs
      var elCount=document.getElementById('presenceCount');
      var elList=document.getElementById('presenceList');
      var state={ apps:{}, visitors:[] };
      function render(){
        try{
          var total=new Set(Object.values(state.apps||{}).flat()).size;
          if(elCount) elCount.textContent=(total||0)+" online";
          if(elList) elList.innerHTML=(state.visitors||[]).map(function(v){
            var ip=v.ip||''; var br=(v.browsers||[]).join(', ');
            var vid=(v.visitorId||'').slice(0,8);
            var dtype=(v.deviceModel||v.deviceType||'');
            var dev=(dtype + (v.os? ' '+v.os:'')).trim();
            var net=v.net||'';
            var right=[br, dev].filter(Boolean).join(' · ');
            return '<a class="text-decoration-none d-flex justify-content-between align-items-center py-1 border-bottom" href="/logs?search='+encodeURIComponent(v.visitorId||ip||'')+'" data-visitor="'+(v.visitorId||'')+'" data-ip="'+ip+'" target="_self" style="color:inherit;">\
              <div><span class="fw-semibold">'+vid+'</span> <span class="text-muted ms-1">'+ip+'</span>'+(net? ' <span class="text-muted">· '+net+'</span>':'')+'</div>\
              <div class="text-muted">'+right+'</div>\
            </a>';
          }).join('');
        }catch(e){}
      }
      if(elList){ elList.addEventListener('click', function(e){ var a=e.target.closest('a[href]'); if(a){ e.preventDefault(); try{ var panel=document.getElementById('presencePanel'); if(panel && window.bootstrap && bootstrap.Collapse){ bootstrap.Collapse.getOrCreateInstance(panel).hide(); } }catch(ex){} window.location.href=a.getAttribute('href'); } }); }
      function getVisitorId(){ try{ var id=localStorage.getItem('visitorId'); if(!id){ id='visitor_'+Math.random().toString(36).substr(2,9)+'_'+Date.now(); localStorage.setItem('visitorId', id);} return id;}catch(e){ return 'visitor_fallback_'+Date.now(); } }
      function getBrowserInfo(){ var ua=navigator.userAgent||navigator.vendor||window.opera; var platform=navigator.platform||''; var maxTP=(typeof navigator.maxTouchPoints==='number')?navigator.maxTouchPoints:0; var name=ua.indexOf('Firefox')>-1?'Firefox': ua.indexOf('SamsungBrowser')>-1?'Samsung Browser': ua.indexOf('OPR')>-1||ua.indexOf('Opera')>-1?'Opera': ua.indexOf('Trident')>-1?'Internet Explorer': ua.indexOf('Edg')>-1||ua.indexOf('Edge')>-1?'Edge': ua.indexOf('Chrome')>-1?'Chrome': ua.indexOf('Safari')>-1?'Safari':'Unknown'; var isIpad=/iPad/i.test(ua)||(platform==='MacIntel'&&maxTP>1); var isIphone=/iPhone/i.test(ua); var isIpod=/iPod/i.test(ua); var isAndroid=/Android/i.test(ua); var isIOS=isIphone||isIpad||isIpod; var os=(function(u){ if(isIOS) return 'iOS'; if(/Windows NT/i.test(u)) return 'Windows'; if(isAndroid) return 'Android'; if(/Macintosh|Mac OS X/i.test(u)) return 'macOS'; if(/Linux/i.test(u)) return 'Linux'; return 'Other'; })(ua); var deviceType=(function(u){ if(isIphone||isIpod) return 'Phone'; if(isIpad) return 'Tablet'; if(isAndroid) return (/Mobi|Mobile/i.test(u)?'Phone':'Tablet'); return 'PC'; })(ua); var deviceModel=isIphone?'iPhone':(isIpad?'iPad':(isIpod?'iPod':'')); return {browser:name, userAgent:ua, platform:navigator.platform, os:os, deviceType:deviceType, deviceModel:deviceModel}; }
      function getTabId(){ try{ var id=sessionStorage.getItem('tabId'); if(!id){ id='tab_'+Math.random().toString(36).substr(2,9)+'_'+Date.now(); sessionStorage.setItem('tabId', id);} return id;}catch(e){ return 'tab_fallback_'+Date.now(); } }
      var socket; var visitorId=getVisitorId(); var browserInfo=getBrowserInfo(); var tabId=getTabId(); var heartbeatInterval;
      function startHeartbeat(){ stopHeartbeat(); heartbeatInterval=setInterval(function(){ if(socket && socket.readyState===WebSocket.OPEN){ socket.send(JSON.stringify({action:'heartbeat', visitorId:visitorId, tabId:tabId})); } else { stopHeartbeat(); } }, 15000); }
      function stopHeartbeat(){ if(heartbeatInterval){ clearInterval(heartbeatInterval); heartbeatInterval=null; } }
      function connect(){ var protocol=location.protocol==='https:'?'wss:':'ws:'; socket=new WebSocket(protocol+'//'+location.host+'/ws/app-status');
        socket.addEventListener('open', function(){ try{ socket.send(JSON.stringify({action:'identify', visitorId:visitorId, browserInfo:browserInfo, tabId:tabId})); socket.send(JSON.stringify({action:'join', app:'org-chart', visitorId:visitorId, tabId:tabId})); startHeartbeat(); }catch(e){} });
        socket.addEventListener('message', function(evt){ try{ var data=JSON.parse(evt.data); if(data.type==='presence'){ state.apps=data.apps||{}; state.visitors=data.visitors||[]; render(); } else if(data.active_users){ state.apps=data.active_users; render(); } }catch(e){} });
        socket.addEventListener('close', function(){ stopHeartbeat(); setTimeout(connect, 5000); });
        socket.addEventListener('error', function(){ stopHeartbeat(); });
      }
      connect();
    })();
    </script>
</body>
</html>
